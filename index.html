<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360Â° Photosphere Capture</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiMzYw4oCwIFBob3Rvc3BoZXJlIENhcHR1cmUiLCJzaG9ydF9uYW1lIjoiUGhvdG9zcGhlcmUiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzAwMDAwMCIsInRoZW1lX2NvbG9yIjoiIzAwN2NmZiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdkbWxsZDBKdmVEMGlNQ0F3SURFME9DQXhORGdpUGdvZ0lEeGpaV2xzY3lCbWFXeHNQU0luSTJZME5qUXpaQ2NnY21WamRGMGlNQ0F3SURFME9DQXhORGdpTHo0S1BDOXpkbWMrIiwic2l6ZXMiOiIxNDR4MTQ0IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow-x: hidden;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .page {
            display: none;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .page.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 3rem;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(45deg, #007cff, #0056b3);
            border: none;
            border-radius: 50px;
            color: white;
            padding: 18px 40px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 124, 255, 0.3);
            margin: 10px;
            min-width: 200px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 124, 255, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .permission-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .status-granted {
            color: #4CAF50;
        }

        .status-denied {
            color: #f44336;
        }

        .capture-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: #000;
        }

        .camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 2px solid #007cff;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 124, 255, 0.6);
        }

        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: #007cff;
            box-shadow: 0 0 10px rgba(0, 124, 255, 0.8);
        }

        .crosshair::before {
            top: 50%;
            left: 15%;
            width: 70%;
            height: 2px;
            transform: translateY(-50%);
        }

        .crosshair::after {
            left: 50%;
            top: 15%;
            width: 2px;
            height: 70%;
            transform: translateX(-50%);
        }

        .capture-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid #007cff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .capture-dot.captured {
            background: #4CAF50;
            border-color: #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.8);
        }

        .capture-dot.target {
            background: #ff6b6b;
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .capture-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
        }

        .capture-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .progress-bar {
            width: 200px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007cff, #4CAF50);
            transition: width 0.3s ease;
        }

        .result-container {
            text-align: center;
            padding: 20px;
        }

        .result-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin: 20px 0;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #007cff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #f44336;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .btn {
                padding: 15px 30px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Page -->
        <div class="page active" id="welcome-page">
            <div class="logo">ðŸ“¸</div>
            <h1 class="title">360Â° Photosphere</h1>
            <p class="subtitle">Capture immersive panoramic photos with AR guidance</p>
            <button class="btn" onclick="requestPermissions()">Get Started</button>
        </div>

        <!-- Permissions Page -->
        <div class="page" id="permissions-page">
            <h2 class="title">Setup Permissions</h2>
            <p class="subtitle">We need access to your device's sensors and camera</p>
            
            <div class="permission-status">
                <div class="status-item">
                    <span>Device Orientation</span>
                    <span id="orientation-status">Pending</span>
                </div>
                <div class="status-item">
                    <span>Camera Access</span>
                    <span id="camera-status">Pending</span>
                </div>
            </div>
            
            <button class="btn" id="request-orientation" onclick="requestOrientation()">Request Orientation</button>
            <button class="btn" id="request-camera" onclick="requestCamera()" disabled>Request Camera</button>
            <button class="btn" id="start-capture" onclick="startCapture()" disabled>Start Capture</button>
        </div>

        <!-- Capture Page -->
        <div class="page" id="capture-page">
            <div class="capture-container">
                <video class="camera-view" id="camera-video" autoplay playsinline></video>
                <canvas class="ar-overlay" id="ar-overlay"></canvas>
                <div class="crosshair"></div>
                
                <div class="capture-info">
                    <div>Photos: <span id="photo-count">0</span> / 36</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div>Point at the glowing dots</div>
                </div>
                
                <div class="capture-controls">
                    <button class="btn" onclick="finishCapture()">Finish Capture</button>
                    <button class="btn" onclick="goHome()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Processing Page -->
        <div class="page" id="processing-page">
            <div class="loading">
                <div class="spinner"></div>
                <h2 class="title">Processing Photosphere</h2>
                <p class="subtitle">Stitching your photos together...</p>
            </div>
        </div>

        <!-- Result Page -->
        <div class="page" id="result-page">
            <div class="result-container">
                <h2 class="title">Your Photosphere</h2>
                <canvas class="result-image" id="result-canvas"></canvas>
                <div>
                    <button class="btn" onclick="savePhotosphere()">Save Image</button>
                    <button class="btn" onclick="captureAnother()">Capture Another</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include OpenCV.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/opencv.js/4.8.0/opencv.js"></script>

    <script>
        // Application state
        let currentPage = 'welcome-page';
        let stream = null;
        let capturedPhotos = [];
        let capturePoints = [];
        let currentTargetIndex = 0;
        let deviceOrientation = null;
        let isCapturing = false;

        // Initialize capture points in a spherical pattern
        function initializeCapturePoints() {
            capturePoints = [];
            const canvas = document.getElementById('ar-overlay');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.3;

            // Create points in 3 rows (upper, middle, lower)
            const rows = 3;
            const pointsPerRow = [8, 12, 8]; // Fewer points at poles
            
            for (let row = 0; row < rows; row++) {
                const points = pointsPerRow[row];
                const y = centerY + (row - 1) * radius * 0.8;
                const currentRadius = radius * Math.cos((row - 1) * Math.PI / 4);
                
                for (let i = 0; i < points; i++) {
                    const angle = (i / points) * 2 * Math.PI;
                    const x = centerX + currentRadius * Math.cos(angle);
                    const pointY = y;
                    
                    capturePoints.push({
                        x: x,
                        y: pointY,
                        captured: false,
                        azimuth: angle,
                        elevation: (row - 1) * Math.PI / 4
                    });
                }
            }
        }

        // Page navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            currentPage = pageId;
        }

        // Request permissions flow
        async function requestPermissions() {
            showPage('permissions-page');
        }

        async function requestOrientation() {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        setupOrientationListener();
                        updateStatus('orientation-status', 'Granted', 'status-granted');
                        document.getElementById('request-camera').disabled = false;
                    } else {
                        updateStatus('orientation-status', 'Denied', 'status-denied');
                    }
                } else {
                    setupOrientationListener();
                    updateStatus('orientation-status', 'Granted', 'status-granted');
                    document.getElementById('request-camera').disabled = false;
                }
            } catch (error) {
                console.error('Orientation permission error:', error);
                updateStatus('orientation-status', 'Error', 'status-denied');
            }
        }

        function setupOrientationListener() {
            window.addEventListener('deviceorientation', (event) => {
                deviceOrientation = {
                    alpha: event.alpha,
                    beta: event.beta,
                    gamma: event.gamma
                };
                if (currentPage === 'capture-page') {
                    checkTargetAlignment();
                }
            });
        }

        async function requestCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                updateStatus('camera-status', 'Granted', 'status-granted');
                document.getElementById('start-capture').disabled = false;
            } catch (error) {
                console.error('Camera permission error:', error);
                updateStatus('camera-status', 'Denied', 'status-denied');
            }
        }

        function updateStatus(elementId, text, className) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = className;
        }

        // Capture functionality
        async function startCapture() {
            showPage('capture-page');
            
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('ar-overlay');
            
            video.srcObject = stream;
            
            // Set up canvas
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            initializeCapturePoints();
            drawCapturePoints();
            
            // Start the capture loop
            isCapturing = true;
            updateCaptureUI();
        }

        function drawCapturePoints() {
            const canvas = document.getElementById('ar-overlay');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw capture points
            capturePoints.forEach((point, index) => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 6, 0, 2 * Math.PI);
                
                if (point.captured) {
                    ctx.fillStyle = '#4CAF50';
                    ctx.strokeStyle = '#4CAF50';
                } else if (index === currentTargetIndex) {
                    ctx.fillStyle = '#ff6b6b';
                    ctx.strokeStyle = '#ff6b6b';
                } else {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.strokeStyle = '#007cff';
                }
                
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }

        function checkTargetAlignment() {
            if (!deviceOrientation || currentTargetIndex >= capturePoints.length) return;
            
            const target = capturePoints[currentTargetIndex];
            const threshold = 0.2; // Alignment threshold
            
            // Simple alignment check based on device orientation
            const alignmentScore = Math.abs(deviceOrientation.alpha - target.azimuth * 180 / Math.PI) + 
                                  Math.abs(deviceOrientation.beta - target.elevation * 180 / Math.PI);
            
            if (alignmentScore < threshold * 180) {
                capturePhoto();
            }
        }

        async function capturePhoto() {
            if (!isCapturing || currentTargetIndex >= capturePoints.length) return;
            
            const video = document.getElementById('camera-video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Store the captured photo
            capturedPhotos.push({
                imageData: canvas.toDataURL('image/jpeg', 0.8),
                point: capturePoints[currentTargetIndex],
                timestamp: Date.now()
            });
            
            // Mark point as captured
            capturePoints[currentTargetIndex].captured = true;
            
            // Move to next target
            currentTargetIndex++;
            
            // Update UI
            updateCaptureUI();
            drawCapturePoints();
            
            // Auto-finish if all points captured
            if (currentTargetIndex >= capturePoints.length) {
                setTimeout(finishCapture, 1000);
            }
        }

        function updateCaptureUI() {
            document.getElementById('photo-count').textContent = capturedPhotos.length;
            const progress = (capturedPhotos.length / capturePoints.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        async function finishCapture() {
            if (capturedPhotos.length === 0) {
                alert('Please capture at least one photo');
                return;
            }
            
            isCapturing = false;
            showPage('processing-page');
            
            // Stop camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Process and stitch photos
            setTimeout(() => {
                stitchPhotosphere();
            }, 1000);
        }

        function stitchPhotosphere() {
            try {
                // Create a simple panoramic result for demonstration
                const resultCanvas = document.getElementById('result-canvas');
                const ctx = resultCanvas.getContext('2d');
                
                // Set canvas size for panoramic view
                resultCanvas.width = 1024;
                resultCanvas.height = 512;
                
                // Create a gradient background as placeholder
                const gradient = ctx.createLinearGradient(0, 0, resultCanvas.width, resultCanvas.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#98FB98');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, resultCanvas.width, resultCanvas.height);
                
                // Draw captured photos in a grid pattern
                const cols = Math.ceil(Math.sqrt(capturedPhotos.length));
                const rows = Math.ceil(capturedPhotos.length / cols);
                const cellWidth = resultCanvas.width / cols;
                const cellHeight = resultCanvas.height / rows;
                
                capturedPhotos.forEach((photo, index) => {
                    const img = new Image();
                    img.onload = () => {
                        const col = index % cols;
                        const row = Math.floor(index / cols);
                        ctx.drawImage(img, col * cellWidth, row * cellHeight, cellWidth, cellHeight);
                    };
                    img.src = photo.imageData;
                });
                
                // Add text overlay
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('360Â° Photosphere Preview', resultCanvas.width / 2, 50);
                ctx.fillText(`${capturedPhotos.length} photos captured`, resultCanvas.width / 2, resultCanvas.height - 50);
                
                showPage('result-page');
                
            } catch (error) {
                console.error('Stitching error:', error);
                showErrorMessage('Failed to process photosphere');
            }
        }

        function savePhotosphere() {
            const canvas = document.getElementById('result-canvas');
            const link = document.createElement('a');
            link.download = `photosphere_${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }

        function captureAnother() {
            // Reset state
            capturedPhotos = [];
            currentTargetIndex = 0;
            showPage('welcome-page');
        }

        function goHome() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            isCapturing = false;
            capturedPhotos = [];
            currentTargetIndex = 0;
            showPage('welcome-page');
        }

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.container').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,console.log("PWA Service Worker")');
            }
            
            // Handle orientation changes
            window.addEventListener('orientationchange', () => {
                if (currentPage === 'capture-page') {
                    setTimeout(() => {
                        const canvas = document.getElementById('ar-overlay');
                        canvas.width = window.innerWidth;
                        canvas.height = window.innerHeight;
                        initializeCapturePoints();
                        drawCapturePoints();
                    }, 100);
                }
            });
        });
    </script>
</body>
</html>
